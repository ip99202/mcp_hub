# ğŸ“‘ Product Requirement Document (PRD) â€“ MCP Hub í™•ì¥Â·ìš´ì˜ ê³ ë„í™”

**ì œí’ˆëª…**: MCP Hub Scale-Out & Observability  

---

## 1. ê°œìš” (Overview)

í˜„ì¬ í—ˆë¸ŒëŠ” ë‹¨ì¼ FastAPI í”„ë¡œì„¸ìŠ¤ ë‚´ ì¸ë©”ëª¨ë¦¬ ë ˆì§€ìŠ¤íŠ¸ë¦¬ì™€ ë‚´ì¥ FastMCP ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ê³  ìˆì–´, ë“±ë¡ëœ ëª¨ë“  MCP ì„œë²„ í˜¸ì¶œì„ ë™ì¼ ì›Œì»¤ì—ì„œ ì²˜ë¦¬í•œë‹¤. ì‹¤ì œ ì„œë¹„ìŠ¤ í™˜ê²½ì—ì„œëŠ” MCP ì„œë²„ë³„ í˜¸ì¶œëŸ‰ í¸ì°¨ê°€ í¬ê³ , ë‹¨ì¼ í”„ë¡œì„¸ìŠ¤ë¡œëŠ” ë™ì‹œì„±Â·ê²©ë¦¬Â·ì¥ì•  ë³µêµ¬ê°€ ì–´ë µë‹¤. ë˜í•œ ìš´ì˜ ì¸¡ë©´ì—ì„œ í•„ìˆ˜ ë¡œê·¸ê°€ ë¶€ì¡±í•´ ì´ìŠˆ ì¬í˜„ ë° SLA ëŒ€ì‘ì´ ì–´ë µë‹¤.  
â†’ **ëª©í‘œ**: MCP ì„œë²„ ë‹¨ìœ„ì˜ ìˆ˜í‰ í™•ì¥ì„ ì§€ì›í•˜ëŠ” ì•„í‚¤í…ì²˜ì™€ ìš´ì˜ ë¡œê·¸ ì²´ê³„ë¥¼ ë§ˆë ¨í•œë‹¤.

---

## 2. ë¬¸ì œ ì •ì˜ & ë³€ê²½ í•„ìš”ì„±

| ì˜ì—­ | í˜„í™© | ë¬¸ì œì  | ê°œì„  í•„ìš”ì„± |
| --- | --- | --- | --- |
| ë ˆì§€ìŠ¤íŠ¸ë¦¬ | í”„ë¡œì„¸ìŠ¤ ì¸ë©”ëª¨ë¦¬ | ë‹¤ì¤‘ ì¸ìŠ¤í„´ìŠ¤ ë¶ˆê°€, ì¬ì‹œì‘ ì‹œ ë°ì´í„° ìœ ì‹¤ | ì™¸ë¶€ ê³µìœ  ì €ì¥ì†Œ í•„ìš” |
| FastMCP ì‹¤í–‰ | í—ˆë¸Œ í”„ë¡œì„¸ìŠ¤ì— ë‚´ì¥ | ì„œë²„ë³„ ë¶€í•˜ ë¶„ë¦¬ ë¶ˆê°€, ì¥ì•  ì‹œ ì „ì²´ ì˜í–¥ | MCP ì„œë²„ë³„ ì „ìš© ì›Œì»¤ í•„ìš” |
| ì„œë²„ ì¶”ê°€ | ìˆ˜ë™ ë“±ë¡ í›„ ë™ì¼ í”„ë¡œì„¸ìŠ¤ì—ì„œ í˜¸ì¶œ | ì‹ ê·œ ì„œë²„ ì¶”ê°€ ì‹œ ì›Œì»¤ ë¯¸ìƒì„± â†’ í˜¸ì¶œ ì‹¤íŒ¨ ê°€ëŠ¥ | ë“±ë¡ ì´ë²¤íŠ¸ ê¸°ë°˜ ìë™ ì›Œì»¤ ë°°í¬ |
| ë¡œê·¸ | uvicorn ê¸°ë³¸ ë¡œê·¸ + ìµœì†Œ ì—ëŸ¬ ë¡œê·¸ | í˜¸ì¶œ ì¶”ì  ì–´ë ¤ì›€, SLA ëŒ€ì‘ ë¶ˆê°€ | êµ¬ì¡°í™”(Structured) í•„ìˆ˜ ë¡œê·¸ ì •ì˜ í•„ìš” |

---

## 3. ëª©í‘œ (Goals)

- Redis ê¸°ë°˜ ê³µìœ  ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¡œ ì„œë²„/íˆ´ ìƒíƒœ ê´€ë¦¬ ë° ë‹¤ì¤‘ ì¸ìŠ¤í„´ìŠ¤ ëŒ€ì‘.
- MCP ì„œë²„ë³„ FastMCP ì›Œì»¤(ë³„ë„ Uvicorn í”„ë¡œì„¸ìŠ¤) ìë™ ìƒì„±Â·í—¬ìŠ¤ì²´í¬Â·ì¢…ë£Œ.
- í—ˆë¸ŒëŠ” MCP í˜¸ì¶œ ì‹œ í•´ë‹¹ ì›Œì»¤ë¡œ í”„ë¡ì‹œ, ì¥ì•  ì‹œ ì¬ì‹œë„/Failover ê°€ëŠ¥ êµ¬ì¡°.
- ìš´ì˜ í•„ìˆ˜ ë¡œê·¸(ìš”ì²­ ìˆ˜ë½, ì™¸ë¶€ API í˜¸ì¶œ, SSE ì†¡ì‹ , ì›Œì»¤ ìƒëª…ì£¼ê¸°, ì˜¤ë¥˜)ë¥¼ êµ¬ì¡°í™” JSONìœ¼ë¡œ ë‚¨ê¹€.
- í”„ëŸ°íŠ¸ì—”ë“œ/ë‚´ë¶€ APIëŠ” ìƒˆ ì•„í‚¤í…ì²˜ë¥¼ íˆ¬ëª…í•˜ê²Œ ì‚¬ìš©í•˜ë„ë¡ ìœ ì§€.

---

## 4. ë²”ìœ„ (Scope)

### í¬í•¨

- Redis Registry êµ¬í˜„ (Async Redis, Pub/Sub ê¸°ë°˜ ë³€ê²½ ì´ë²¤íŠ¸).
- Server Supervisor ì„œë¹„ìŠ¤(íŒŒì´ì¬) ë„ì…: ì›Œì»¤ ìŠ¤í°/ì¢…ë£Œ/í—¬ìŠ¤ì²´í¬.
- MCP í˜¸ì¶œ ê²½ë¡œ ìˆ˜ì •: FastMCP ë‚´ í˜¸ì¶œ ì œê±° â†’ ì›Œì»¤ë¡œ HTTP í”„ë¡ì‹œ.
- êµ¬ì¡°í™” ë¡œê·¸ ì¶”ê°€ ë° ê³µí†µ Trace ID/Request ID ì „íŒŒ.
- Docker Compose ë° ì„¤ì •(`.env`) ì—…ë°ì´íŠ¸.
- ëŒ€ì‹œë³´ë“œì— ì›Œì»¤ ìƒíƒœ í‘œì‹œ.

### ì œì™¸

- ë©€í‹° ë¦¬ì „ì— ê±¸ì¹œ ì›Œì»¤ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜(í–¥í›„ K8s/ì»¨í…Œì´ë„ˆ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ ì—°ë™).
- ê³ ê¸‰ ëª¨ë‹ˆí„°ë§(ë©”íŠ¸ë¦­ ì‹œìŠ¤í…œ, ë¶„ì‚° íŠ¸ë ˆì´ì‹±).
- ì¸ì¦/ê¶Œí•œ ì²´ê³„ í™•ëŒ€.
- ì˜êµ¬ DB(ë‹¨ Redis ì¸ë©”ëª¨ë¦¬ ì˜ì†ë§Œ ê³ ë ¤).

---

## 5. ì‚¬ìš©ì ì‹œë‚˜ë¦¬ì˜¤

1. ìš´ì˜ìê°€ ìƒˆ REST APIë¥¼ MCP ì„œë²„ë¡œ ë“±ë¡ (`POST /api/servers/{id}`).
2. Redis Registryê°€ ì„œë²„ ì •ë³´ë¥¼ ì €ì¥í•˜ê³  `server.upsert` ì´ë²¤íŠ¸ ë°œí–‰.
3. Supervisorê°€ ì´ë²¤íŠ¸ë¥¼ ê°ì§€í•´ ì„œë²„ ì „ìš© FastMCP ì›Œì»¤(Uvicorn)ë¥¼ ì ì ˆí•œ í¬íŠ¸ì— ê¸°ë™, `/mcp-servers/{id}` í”„ë¡ì‹œ ì—”ë“œí¬ì¸íŠ¸ ì—…ë°ì´íŠ¸.
4. í˜¸ì¶œìê°€ `POST /mcp/{id}/{tool}`ë¡œ ìš”ì²­ â†’ í—ˆë¸Œê°€ ì›Œì»¤ í¬íŠ¸ë¥¼ ì¡°íšŒí•˜ì—¬ SSE ìŠ¤íŠ¸ë¦¼ì„ í”„ë¡ì‹œ.
5. í˜¸ì¶œ íë¦„/ì™¸ë¶€ API ì‘ë‹µ/ì›Œì»¤ ìƒíƒœ ë³€í™”ëŠ” êµ¬ì¡°í™” ë¡œê·¸ë¡œ ìˆ˜ì§‘.
6. ì„œë²„ ì‚­ì œ ì‹œ Supervisorê°€ ì›Œì»¤ ì¢…ë£Œ.

---

## 6. ì£¼ìš” ë³€ê²½ ì‚¬í•­

### 6.1 ë ˆì§€ìŠ¤íŠ¸ë¦¬ êµì²´

- `backend/app/registry.py` â†’ `RedisRegistry` (redis.asyncio)
  - í‚¤ ìŠ¤í‚´: `mcp:servers`, `mcp:tools:{serverId}` (Hash/JSON).
  - `stats()`ëŠ” Redis ì—°ì‚° í™œìš©, ë©±ë“± ì¶”êµ¬.
  - Pub/Sub ì±„ë„ `mcp:events`ì— `server.upsert/delete`, `tool.upsert/delete` ì´ë²¤íŠ¸ ì†¡ì‹ .
  - ê¸°ì¡´ ì‹±ê¸€í†¤ `registry`ëŠ” async ì´ˆê¸°í™” ì§€ì›.

### 6.2 Server Supervisor

- ì‹ ì„¤ `backend/app/server_supervisor.py`
  - `start()`ê°€ lifespanì—ì„œ íƒœìŠ¤í¬ë¡œ ì‹¤í–‰.
  - Redis ì´ë²¤íŠ¸ êµ¬ë… â†’ ì„œë²„ë³„ ì›Œì»¤ í”„ë¡œì„¸ìŠ¤ ìƒíƒœ ê´€ë¦¬.
  - ì•± ì¬ì‹œì‘ ì‹œ `mcp:server_runtime:*` í‚¤ì™€ ì„œë²„ ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¥¼ í’€ ìŠ¤ìº”í•´ ì›Œì»¤ í˜„í™©ì„ ì¬êµ¬ì„±(ì„¸ì…˜ ë³µêµ¬, ìœ ë ¹ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬).
  - Supervisor ê¸°ë™ì´ ì›Œì»¤ë³´ë‹¤ ëŠ¦ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì´ˆê¸° í’€ ì‹±í¬ í›„ Pub/Sub êµ¬ë…ì„ ë¶™ì´ê³ , ëˆ„ë½ ì´ë²¤íŠ¸ëŠ” ì •ê¸° ë¦¬ì»¨ì‹¤(ì¬ë™ê¸°í™”)ë¡œ ë³´ì™„.
  - ì›Œì»¤: `uvicorn.run(fastmcp_subapp, host=0.0.0.0, port=alloc)` í˜•íƒœ.
  - í¬íŠ¸ ì „ëµ: OS free port finder ì‚¬ìš© + Supervisorê°€ ì ìœ  í¬íŠ¸ë¥¼ Redis Set(`mcp:runtime_ports`)ì— ê¸°ë¡/ë½ì„ ê±¸ì–´ ë‹¤ì¤‘ ì¸ìŠ¤í„´ìŠ¤ ê°„ ì¶©ëŒ ë°©ì§€.
  - ìƒíƒœ ì €ì¥: `mcp:server_runtime:{id}` (status, pid, port, last_heartbeat) â€” í—ˆë¸Œ ì¬ì‹œì‘ ì‹œ ì´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì›Œì»¤ ì¬ì—°ê²° ë˜ëŠ” ì¬ê¸°ë™.
  - í—¬ìŠ¤ì²´í¬: `/healthz` ì£¼ê¸° í˜¸ì¶œ, ì‹¤íŒ¨ ì‹œ ì¬ê¸°ë™.
  - ì„œë²„ ë¹„í™œì„±í™” ì‹œ ì›Œì»¤ graceful shutdown (SIGTERM â†’ timeout í›„ SIGKILL).

### 6.3 MCP ë¼ìš°íŒ… ë° í˜¸ì¶œ

- `routes_mcp.py`
  - `call_tool`ì´ Redisì—ì„œ ì›Œì»¤ í¬íŠ¸ ê²€ìƒ‰ â†’ `httpx.AsyncClient`ë¡œ SSE ìŠ¤íŠ¸ë¦¼ í”„ë¡ì‹œ.
  - ì›Œì»¤ ë¯¸ë“±ë¡/í¬íŠ¸ ì—†ìŒ â†’ 503 ë°˜í™˜ + ë¡œê·¸.
  - ìš”ì²­ë³„ `request_id` ìƒì„± í›„ ë¡œê·¸ ë° SSE ë©”ì‹œì§€ì— ì‚½ì….
  - JSON Schema ê²€ì¦ ë¡œì§ì€ í—ˆë¸Œì—ì„œ ìœ ì§€.

- `fastmcp_runtime.py`
  - ê¸°ì¡´ ê¸€ë¡œë²Œ FastMCP ì‚¬ìš© ì œê±° ë˜ëŠ” `legacy` í”Œë˜ê·¸ ì²˜ë¦¬.
  - ì›Œì»¤ê°€ `build_fastmcp_sse_app_for(server_id)`ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ refactor.
  - í—ˆë¸Œ í”„ë¡œì„¸ìŠ¤ì—ì„œëŠ” FastMCP íˆ´ ë“±ë¡ì´ ì•„ë‹Œ Redis ì´ë²¤íŠ¸ë§Œ ë°œí–‰.

### 6.4 HTTP ì–´ëŒ‘í„° ë¡œê¹…

- `http_adapter.py`
  - í˜¸ì¶œ ì „í›„ êµ¬ì¡°í™” ë¡œê·¸(`tool.http.request`, `tool.http.response`), latency(ms), status, ì˜¤ë¥˜.
  - ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ ì •ì±…ì€ ì¶”í›„ ì˜µì…˜ìœ¼ë¡œ; í˜„ì¬ëŠ” ë‹¨ì¼ ì‹œë„.

### 6.5 ì„¤ì • & ë°°í¬

- `.env`:
  - `REDIS_URL`, `MCP_WORKER_BASE_PORT`, `MCP_WORKER_MAX`, `MCP_WORKER_IDLE_TTL`.
- `docker-compose.yml`:
  - `redis` ì„œë¹„ìŠ¤ ì¶”ê°€, backendì— `depends_on`.
  - Supervisorê°€ ì •ìƒ ë™ì‘í•˜ë„ë¡ `command` ë˜ëŠ” `entrypoint` ì¡°ì •.
- ë¡œì»¬ ê°œë°œìš© `scripts/bootstrap_registry.py`: Redis ì´ˆê¸° ë°ì´í„°(ê¸°ì¡´ fakestore/fruits).

### 6.6 í”„ëŸ°íŠ¸ì—”ë“œ í‘œì‹œ

- `frontend` ëŒ€ì‹œë³´ë“œ ì„œë²„ ìƒì„¸ íŒ¨ë„ì— ì›Œì»¤ ìƒíƒœ(í¬íŠ¸, í—¬ìŠ¤, ìµœê·¼ ì‹¤íŒ¨) ì„¹ì…˜ ì¶”ê°€.
- ì¬ì‹œì‘ ë²„íŠ¼(ì˜µì…˜) â†’ Supervisorì— `POST /api/servers/{id}/restart` ì¶”ê°€.

---

## 7. ê¸°ìˆ  ìš”êµ¬ì‚¬í•­

- Python 3.11+, `redis>=5` (asyncio), `structlog`.
- Uvicorn ì›Œì»¤ í”„ë¡œì„¸ìŠ¤ëŠ” Supervisorê°€ `multiprocessing` ë˜ëŠ” `asyncio.create_subprocess_exec`ë¡œ ê´€ë¦¬.
- Redis ì—°ê²° ì¥ì•  ëŒ€ë¹„ ë°±ì˜¤í”„ & ì¬ì—°ê²°.
- ë¡œê·¸ í¬ë§·: `structlog.processors.JSONRenderer`, ê³µí†µ í•„ë“œ `service`, `event`, `request_id`, `server`, `tool`.
- SSE í”„ë¡ì‹œì—ì„œ ë°±í”„ë ˆì…” ì²˜ë¦¬: `async for line in response.aiter_lines()`.

---

## 8. ìš´ì˜ ë¡œê·¸ ì •ì˜

| ì´ë²¤íŠ¸ | ë¡œê·¸ í‚¤ | í•„ìˆ˜ í•„ë“œ | ì„¤ëª… |
| --- | --- | --- | --- |
| MCP í˜¸ì¶œ ìˆ˜ë½ | `tool.call.accepted` | request_id, server, tool, args_size | ìš”ì²­ ì´ˆì… |
| ì›Œì»¤ í”„ë¡ì‹œ ì‹œì‘/ì¢…ë£Œ | `tool.call.proxy.start` / `tool.call.proxy.done` | request_id, target_url, status, latency | ì›Œì»¤ì™€ì˜ í†µì‹  ìƒíƒœ |
| íˆ´ ì˜¤ë¥˜ | `tool.call.failed` | request_id, error, traceback | ì˜ˆì™¸ ë°œìƒ |
| ì™¸ë¶€ HTTP í˜¸ì¶œ | `tool.http.request` / `tool.http.response` | request_id, method, url, latency, status | API í˜¸ì¶œ ì¶”ì  |
| ì›Œì»¤ ë¼ì´í”„ì‚¬ì´í´ | `worker.spawned`, `worker.terminated`, `worker.restart` | server, pid, port, reason | Supervisor í™œë™ |
| í—¬ìŠ¤ì²´í¬ | `worker.health.fail` | server, port, response_code | ì‹¤íŒ¨ ì‹œë§Œ ë¡œê·¸ |

---

## 9. ì„±ê³µ ê¸°ì¤€ & í…ŒìŠ¤íŠ¸

- **ê¸°ëŠ¥**: ì„œë²„ ë“±ë¡ ì‹œ 5ì´ˆ ì´ë‚´ ì›Œì»¤ ìƒì„± ë° `/mcp/{id}/{tool}` í˜¸ì¶œ ì„±ê³µ.
- **í™•ì¥ì„±**: 20ê°œ MCP ì„œë²„ ë“±ë¡ ìƒíƒœì—ì„œ ë™ì‹œ í˜¸ì¶œ 200 rpsì—ì„œ ì‹¤íŒ¨ìœ¨ < 1%.
- **ë‚´ê³ ì¥ì„±**: ì›Œì»¤ ê°•ì œ ì¢…ë£Œ ì‹œ 10ì´ˆ ì´ë‚´ ìë™ ì¬ê¸°ë™.
- **ë¡œê·¸**: Kibana/Datadog ë“±ì—ì„œ ì´ë²¤íŠ¸ í•„í„°ë§ ê°€ëŠ¥(êµ¬ì¡°í™” JSON).
- í…ŒìŠ¤íŠ¸:
  - ë‹¨ìœ„: Redis Registry CRUD, Supervisor ìƒíƒœ ì „ì´.
  - í†µí•©: í˜¸ì¶œ â†’ ì›Œì»¤ í”„ë¡ì‹œ â†’ ì™¸ë¶€ Mock API.
  - Load Test: `locust` ë˜ëŠ” `k6`ë¡œ SSE ìš”ì²­ ë¶€í•˜.

---

## 10. ë¡¤ì•„ì›ƒ ê³„íš

1. Redis ë° Supervisor ê¸°ëŠ¥ í”Œë˜ê·¸ ë„ì… (`MCP_SUPERVISOR_ENABLED`).
2. ìŠ¤í…Œì´ì§•ì—ì„œ ê¸°ì¡´ ì¸ë©”ëª¨ë¦¬ ëª¨ë“œì™€ ë³‘í–‰ í…ŒìŠ¤íŠ¸.
3. ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜: ê¸°ì¡´ ì„œë²„/íˆ´ JSON dump â†’ Redis import.
4. í”Œë˜ê·¸ on í›„ ë¡œê·¸Â·ëª¨ë‹ˆí„°ë§ ê²€ì¦.
5. ë¬¸ì œ ì‹œ ì¦‰ì‹œ í”Œë˜ê·¸ offë¡œ ë¡¤ë°±.

---

## 11. ë¦¬ìŠ¤í¬ & ëŒ€ì‘

- **Redis ì¥ì• **: ë ˆì§€ìŠ¤íŠ¸ë¦¬/ì›Œì»¤ ì •ë³´ ìƒì‹¤ â†’ í—ˆë¸Œê°€ ì„œë²„ ë¹„ê°€ìš© íŒë‹¨. ëŒ€ì‘: Redis Sentinel/í´ëŸ¬ìŠ¤í„° ê³ ë ¤, ì»¤ë„¥ì…˜ ì¬ì‹œë„ ë¡œì§.
- **ì›Œì»¤ í­ì£¼**: ì„œë²„ ìˆ˜ ë§ì„ ë•Œ í¬íŠ¸ ê³ ê°ˆ â†’ `MCP_WORKER_MAX` ì œí•œ ë° ìŠ¤ì¼€ì¼ ì „ëµ ë¬¸ì„œí™”.
- **ë¡œê·¸ í­ì¦**: ê³ ë¶€í•˜ ì‹œ I/O ë¶€ë‹´ â†’ ìƒ˜í”Œë§ ì˜µì…˜ ë˜ëŠ” ë¡œê·¸ ë ˆë²¨ ì¡°ì •.

---

## 12. í›„ì† í™•ì¥ ì œì•ˆ (Speculative)

- Supervisorë¥¼ K8s Operator ìŠ¤íƒ€ì¼ë¡œ ëŒ€ì²´í•˜ì—¬ MCP ì„œë²„ë³„ Deployment ìë™ ìƒì„±. (ì¶”í›„)
- Redis Stream ê¸°ë°˜ í˜¸ì¶œ ê°ì‚¬ ë¡œê·¸ ì €ì¥ í›„ ë¶„ì„ íŒŒì´í”„ë¼ì¸ ì—°ê³„.
- í˜¸ì¶œ ì¬ì‹œë„, íšŒë¡œ ì°¨ë‹¨ê¸°(circuit breaker) ë„ì…ìœ¼ë¡œ ì™¸ë¶€ API ì¥ì•  ëŒ€ì‘ë ¥ í–¥ìƒ.

---
